#!/bin/sh
set -e

PKG_NAME=chissu-pam
PAM_SNIPPET=/usr/share/pam-configs/chissu

# shellcheck disable=SC1091
. /usr/share/chissu-pam/install-common.sh

log() {
    echo "$PKG_NAME: $*"
}

fail() {
    echo "$PKG_NAME: $*" >&2
    exit 1
}

wire_pam() {
    if ! command -v pam-auth-update >/dev/null 2>&1; then
        fail "pam-auth-update is required to wire PAM; install it and rerun 'dpkg --configure -a'"
    fi
    if [ ! -f "$PAM_SNIPPET" ]; then
        fail "missing PAM snippet at $PAM_SNIPPET; package payload may be incomplete"
    fi
    log "Enabling pam-auth-update entry for chissu"
    if ! pam-auth-update --package --enable chissu; then
        fail "pam-auth-update failed; ensure PAM state is synced and retry"
    fi
}

case "$1" in
    configure)
        maybe_download_models
        wire_pam
        ;;
esac

exit 0
