%global debug_package %{nil}

Name:           chissu-pam
Version:        __VERSION__
Release:        __RELEASE__%{?dist}
Summary:        Infrared-ready facial authentication CLI + PAM helper

License:        LGPL-2.1+
URL:            https://github.com/sett/chissu-pam
Source0:        %{name}-%{version}.tar.gz
BuildArch:      __ARCH__
Requires:       dlib, openblas, lapack, gtk3, systemd-libs, libudev, curl, bzip2

%description
chissu-pam verifies Linux logins using an IR-capable V4L2 camera. The package
ships the `chissu-cli` helper plus the `pam_chissu` module so operators can
enroll embeddings and wire PAM stacks without compiling from source.

%prep
%setup -q

%build
# Binaries are provided by the packaging helper

%install
rm -rf "%{buildroot}"
mkdir -p "%{buildroot}"
cp -pr artifacts/* "%{buildroot}/"

%files
%license LICENSE
/usr/bin/chissu-cli
/usr/lib64/security/libpam_chissu.so
%config(noreplace) /etc/chissu-pam/config.toml
/usr/share/doc/chissu-pam/README.RPM
%dir /var/lib/chissu-pam
%dir /var/lib/chissu-pam/dlib-models
/var/lib/chissu-pam/dlib-models/.keep
%dir /var/lib/chissu-pam/embeddings
/var/lib/chissu-pam/embeddings/.keep

%post
MODEL_DIR=/var/lib/chissu-pam/dlib-models
EMBED_DIR=/var/lib/chissu-pam/embeddings
LANDMARK_FILE=shape_predictor_68_face_landmarks.dat
ENCODER_FILE=dlib_face_recognition_resnet_model_v1.dat
LANDMARK_URL=https://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2
ENCODER_URL=https://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2
SKIP_DOWNLOAD="${CHISSU_PAM_SKIP_MODEL_DOWNLOAD:-0}"

maybe_download() {
    local name="$1" url="$2" dest="$3"
    if [ -f "$dest" ]; then
        echo "chissu-pam: $name already present at $dest; skipping"
        return 0
    fi
    if [ "$SKIP_DOWNLOAD" = "1" ]; then
        echo "chissu-pam: skipping $name download (CHISSU_PAM_SKIP_MODEL_DOWNLOAD=1)"
        return 0
    fi
    tmp=$(mktemp -d)
    archive="$tmp/archive.bz2"
    echo "chissu-pam: downloading $name"
    if ! curl -fsSL "$url" -o "$archive"; then
        echo "chissu-pam: failed to download $url" >&2
        rm -rf "$tmp"
        exit 1
    fi
    if ! bzip2 -d -c "$archive" > "$dest"; then
        echo "chissu-pam: failed to decompress $archive" >&2
        rm -rf "$tmp"
        exit 1
    fi
    chmod 0644 "$dest"
    rm -rf "$tmp"
}

install -d -m 0755 "$MODEL_DIR" "$EMBED_DIR"
maybe_download "$LANDMARK_FILE" "$LANDMARK_URL" "$MODEL_DIR/$LANDMARK_FILE"
maybe_download "$ENCODER_FILE" "$ENCODER_URL" "$MODEL_DIR/$ENCODER_FILE"

%postun
if [ "$1" -eq 0 ]; then
    rm -f /etc/chissu-pam/config.toml /etc/chissu-pam/config.toml.rpmsave 2>/dev/null || true
    if [ "${CHISSU_PAM_PURGE_MODELS:-0}" = "1" ]; then
        echo "chissu-pam: removing downloaded dlib models"
        rm -f /var/lib/chissu-pam/dlib-models/shape_predictor_68_face_landmarks.dat
        rm -f /var/lib/chissu-pam/dlib-models/dlib_face_recognition_resnet_model_v1.dat
    fi
fi

%changelog
# Auto-generated by packaging helper; maintainers should replace during release prep
* Thu Nov 23 2025 Chissu Maintainers <ops@chissu.dev> - __VERSION__-__RELEASE__
- Automated build
